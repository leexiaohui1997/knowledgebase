# 图片功能测试指南

## 🎯 工作原理

### 数据流程

```
粘贴图片
    ↓
fileUpload 回调触发
    ↓
保存图片到本地文件 (PNG/JPG)
    ↓
记录映射：base64 ↔ 文件名
    ↓
返回 base64 给编辑器显示
    ↓
编辑器正常显示图片 ✓
    ↓
用户点击保存
    ↓
将 base64 转换为 local-image://文件名
    ↓
保存到数据库（体积小）✓
    ↓
下次加载
    ↓
从本地文件读取图片
    ↓
转换为 base64 显示
    ↓
循环...
```

---

## 🧪 测试步骤

### 测试 1：粘贴图片（30秒）

1. **准备图片**
   - 截图或复制任意图片

2. **粘贴**
   ```
   在编辑器中按 Cmd/Ctrl + V
   ```

3. **预期结果**
   - ✅ Console 显示：
     ```
     Uploading image, size: XXX KB
     Image saved: 1759300122184_..._.png
     ```
   - ✅ 图片立即显示在编辑器中
   - ✅ 可以正常编辑周围文字

4. **保存文档**
   ```
   点击「💾 保存」或按 Cmd/Ctrl + S
   ```

5. **检查 Console**
   ```
   Saving document, content length: XXX
   Images in mapping: 1
   ```

6. **验证持久化**
   ```
   - 切换到其他文件
   - 再切回来
   - 图片仍然显示 ✓
   ```

### 测试 2：多张图片（1分钟）

1. **连续粘贴 3 张图片**
   ```
   粘贴图片1
   粘贴图片2
   粘贴图片3
   ```

2. **预期**
   - ✅ 所有图片都正常显示
   - ✅ Console 显示 3 次保存日志

3. **保存并重新加载**
   - 保存文档
   - 切换文件后切回
   - 3 张图片都正常显示 ✓

### 测试 3：拖拽图片（30秒）

1. **从文件管理器拖动图片**
   ```
   拖动 PNG/JPG 文件到编辑器
   ```

2. **预期**
   - ✅ 图片自动上传
   - ✅ Console 显示保存日志
   - ✅ 图片正常显示

---

## 📁 验证文件

### 检查图片文件

```bash
# 查看保存的图片
ls -lh ~/Library/Application\ Support/vite-vue3-electron-demo/images/

# 应该看到类似：
# 1759300122184_1759305002100_a3b4c5.png
# 1759300122184_1759305012474_wkp463.png
```

### 检查文档内容

打开 data.json 查看文档内容：
```bash
cat ~/Library/Application\ Support/vite-vue3-electron-demo/data.json | grep "local-image"
```

应该看到：
```
"content": "# 标题\n\n![图片](local-image://1759300122184_..._.png)\n\n文字..."
```

---

## ✅ 成功标准

### 编辑器中
- [x] 粘贴图片后立即显示
- [x] 图片清晰无损
- [x] 可以编辑周围文字
- [x] 保存后不消失

### Console 日志
- [x] "Uploading image, size: XXX KB"
- [x] "Image saved: filename.png"
- [x] "Saving document, content length: XXX"
- [x] "Images in mapping: N"

### 文件系统
- [x] images/ 目录存在
- [x] 图片文件已创建
- [x] 文件名格式正确

### 数据库
- [x] 文档内容包含 `local-image://`
- [x] 不包含长长的 base64
- [x] 文档体积合理

---

## 💡 工作机制

### 为什么这样设计？

1. **编辑器显示** - 使用 base64
   - Cherry Markdown 原生支持
   - 无需特殊配置
   - 显示流畅

2. **存储** - 使用本地文件
   - 文档体积小
   - 易于管理
   - 可以备份

3. **映射机制** - 双向转换
   - 加载时：`local-image://` → base64
   - 保存时：base64 → `local-image://`
   - Map 存储对应关系

---

## 🐛 如果图片不显示

### 检查清单

1. **Console 有 "Image saved" 吗？**
   - ✅ 有 → 上传成功
   - ❌ 没有 → 上传失败，检查错误

2. **图片文件存在吗？**
   ```bash
   ls ~/Library/Application\ Support/vite-vue3-electron-demo/images/
   ```
   - ✅ 存在 → 保存成功
   - ❌ 不存在 → 检查存储服务

3. **重新加载后还显示吗？**
   - ✅ 显示 → 映射机制正常
   - ❌ 不显示 → 检查转换逻辑

### 解决方法

如果图片不显示，尝试：
```
1. 查看 Console 错误
2. 检查文件权限
3. 重启应用
4. 清空数据重新测试
```

---

## 📊 性能说明

### 文档大小对比

**使用 base64**（1张 500KB 图片）:
```
文档大小：约 700KB（增大 40%）
```

**使用本地文件**（1张 500KB 图片）:
```
文档大小：约 50 字节（仅路径）
图片文件：500KB（单独存储）
总计更小，且可复用
```

### 加载速度

- 首次加载：需要读取图片文件
- 后续加载：可以缓存
- 整体速度：与 base64 相当或更快

---

**现在粘贴图片应该正常显示并自动保存到本地了！** 📸✨

