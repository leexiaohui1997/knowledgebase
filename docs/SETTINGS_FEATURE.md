# ⚙️ 设置功能

本文档介绍应用的设置功能和图片清理功能。

---

## 📋 功能概述

### 设置入口

在以下页面的右上角都有设置按钮（⚙️）：
1. **知识库列表页** - 右上角设置图标
2. **知识库详情页** - 右上角设置图标

点击后打开设置弹窗。

### 设置布局

设置弹窗采用经典的**左侧导航 + 右侧内容**布局：

```
┌────────────────────────────────┐
│  ⚙️ 设置            [X]        │
├─────────┬──────────────────────┤
│         │                      │
│ 📊 通用 │  通用设置            │
│         │                      │
│         │  🧹 清理图片         │
│         │  [开始清理]          │
│         │                      │
└─────────┴──────────────────────┘
```

---

## 🧹 图片清理功能

### 功能说明

随着使用时间增长，可能会有一些图片被删除或替换，但文件仍然保存在存储中。图片清理功能可以：

1. 🔍 **扫描所有文档** - 检查哪些图片正在被使用
2. 📊 **识别未使用图片** - 找出存储中但未被引用的图片
3. 🗑️ **安全删除** - 删除前二次确认，防止误删

### 使用方法

#### 步骤 1：打开设置

点击右上角的设置按钮（⚙️）

#### 步骤 2：进入清理图片

1. 左侧导航选择 "通用"（默认选中）
2. 看到 "清理图片" 选项

#### 步骤 3：开始扫描

1. 点击 "开始清理" 按钮
2. 系统自动扫描所有文档和图片
3. 扫描完成后：
   - 如果有未使用的图片：弹出确认窗口
   - 如果没有：显示提示"没有发现未使用的图片！"

#### 步骤 4：确认删除

如果发现未使用的图片，会显示确认窗口：

```
┌────────────────────────────────┐
│ ⚠️ 确认清理图片     [X]        │
├────────────────────────────────┤
│ 发现 3 张未使用的图片          │
│ ⚠️ 删除后无法恢复             │
├────────────────────────────────┤
│ 📷 [预览]  local-image://...   │
│ 📷 [预览]  local-image://...   │
│ 📷 [预览]  local-image://...   │
├────────────────────────────────┤
│         [取消]  [确认删除(3)]  │
└────────────────────────────────┘
```

窗口内容：
- 📊 显示未使用图片数量
- ⚠️ 警告提示
- 🖼️ 图片预览（缩略图）
- 📝 图片路径
- ❌ 取消 / ✅ 确认按钮

#### 步骤 5：完成清理

点击 "确认删除" 后：
- 🗑️ 删除选中的图片
- ✅ 显示成功提示
- 💾 释放存储空间

---

## 🔧 技术实现

### 扫描逻辑

1. **获取所有图片**
   - Electron 版：读取 `images/` 文件夹
   - Web 版：查询 IndexedDB 的 `images` ObjectStore

2. **扫描文档内容**
   - 遍历所有知识库的所有文档
   - 使用正则表达式提取图片引用：
     ```javascript
     /!\[([^\]]*)\]\((local-image:\/\/[^)]+)\)/g
     ```

3. **对比差异**
   - 找出存储中有但文档中未引用的图片
   - 这些就是未使用的图片

### 删除流程

```
用户点击 "开始清理"
    ↓
调用 storage.getUnusedImages()
    ↓
返回未使用图片列表
    ↓
显示确认弹窗（带预览）
    ↓
用户确认
    ↓
调用 storage.cleanupUnusedImages(imagePaths)
    ↓
批量删除图片
    ↓
显示成功提示
```

### 存储层实现

#### IStorage 接口

```typescript
export interface IStorage {
  // ... 其他方法
  
  // 获取未使用的图片列表
  getUnusedImages(): Promise<string[]>
  
  // 清理指定的图片
  cleanupUnusedImages(imagePaths: string[]): Promise<void>
}
```

#### Electron 实现

```typescript
// electron/image-storage.ts
export function getAllImages(): string[]
export function cleanupImages(fileNames: string[]): number

// electron/ipc-handlers.ts
ipcMain.handle('get-unused-images', ...)
ipcMain.handle('cleanup-unused-images', ...)
```

#### Web 实现

```typescript
// src/storage/web-storage.ts
async getUnusedImages(): Promise<string[]> {
  // 1. 从 IndexedDB 获取所有图片
  // 2. 从所有文档中提取已使用的图片
  // 3. 返回差异
}

async cleanupUnusedImages(imagePaths: string[]): Promise<void> {
  // 批量从 IndexedDB 删除图片
}
```

---

## 🎨 UI 设计

### 设置按钮

- **位置**：页面右上角
- **样式**：圆形图标按钮，边框样式
- **悬停效果**：绿色高亮
- **尺寸**：40×40px

### 设置弹窗

- **尺寸**：800×600px
- **布局**：左侧导航（200px）+ 右侧内容
- **样式**：现代扁平风格
- **动画**：平滑过渡

### 确认弹窗

- **尺寸**：600×最大 80vh
- **样式**：警告色调（橙色）
- **功能**：
  - 图片预览（60×60px 缩略图）
  - 图片路径显示
  - 双按钮操作

---

## 📊 使用场景

### 何时需要清理图片？

1. **文档大量编辑后**
   - 多次修改文档，替换了图片
   - 旧图片仍保留在存储中

2. **删除文档后**
   - 删除包含图片的文档
   - 图片文件未被自动删除

3. **存储空间紧张时**
   - IndexedDB 接近配额（Web 版）
   - 磁盘空间不足（Electron 版）

4. **定期维护**
   - 建议每月或每季度清理一次
   - 保持应用轻量和高效

### 清理频率建议

| 使用强度 | 建议频率 |
|---------|---------|
| 轻度使用（偶尔编辑） | 每季度 |
| 中度使用（每周编辑） | 每月 |
| 重度使用（每天编辑） | 每周 |

---

## ⚠️ 注意事项

### 安全提示

1. **删除不可恢复**
   - 图片删除后无法找回
   - 请仔细确认列表中的图片

2. **备份建议**
   - 清理前建议备份重要数据
   - Electron 版：备份 userData 目录
   - Web 版：暂无自动备份（未来功能）

3. **谨慎操作**
   - 确认列表中的图片确实不需要
   - 如有疑问，选择"取消"

### 已知限制

1. **扫描性能**
   - 文档数量多时扫描可能需要几秒钟
   - 这是正常的，请耐心等待

2. **误判可能**
   - 极少数情况可能误判图片未使用
   - 删除前务必检查列表

3. **不支持批量操作**
   - 目前每次需要完整扫描
   - 未来可能添加增量扫描

---

## 🔮 未来扩展

### 计划功能

- [ ] 显示每张图片的大小
- [ ] 显示总共可释放的空间
- [ ] 图片使用统计（哪些文档使用了该图片）
- [ ] 一键导出/备份所有图片
- [ ] 定时自动清理（可选）
- [ ] 清理历史记录

### 更多设置选项

- [ ] 主题设置（亮色/暗色）
- [ ] 编辑器设置
- [ ] 快捷键设置
- [ ] 数据导入/导出
- [ ] 同步设置（云端）

---

## 📝 使用示例

### 正常清理流程

```
1. 编辑了多篇文档
2. 替换了一些图片
3. 打开设置 → 通用 → 清理图片
4. 系统扫描发现 5 张未使用图片
5. 查看列表，确认都是旧图片
6. 点击"确认删除"
7. 成功清理 5 张图片，释放空间
```

### 取消清理流程

```
1. 打开设置 → 清理图片
2. 系统扫描发现 2 张未使用图片
3. 查看列表，发现有一张还需要使用
4. 点击"取消"
5. 图片保留，无任何变化
```

---

## 💡 最佳实践

### 清理前

1. ✅ 确保所有文档已保存
2. ✅ 重要数据已备份
3. ✅ 仔细检查待删除列表

### 清理时

1. ✅ 查看每张图片的预览
2. ✅ 检查图片路径
3. ✅ 确认不再需要

### 清理后

1. ✅ 验证文档中的图片正常显示
2. ✅ 检查重要文档没有丢失图片
3. ✅ 如有问题，及时反馈

---

## 🎉 总结

图片清理功能帮助您：
- ✅ 自动识别未使用的图片
- ✅ 安全删除，释放空间
- ✅ 保持应用轻量高效
- ✅ 延长应用生命周期

**建议定期使用此功能进行维护！** 🧹✨

